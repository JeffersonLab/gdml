# This makefile is used for building GDML according to LCG release procedure

ifndef ${GDMLTOP}
GDMLTOP=${PWD}/..
endif


GDMLTARDIR = ${GDMLTOP}/../downloads

GDML_VERSION = 2_9_0

export PLATFORM=${SCRAM_ARCH}

G4BIND_INC = G4Processor G4Subscribers G4Writer G4Evaluator
COMMON_INC = Saxana Schema Writer Processes

G4BIND_LIBS = ${addprefix ${GDMLTOP}/lib,${addsuffix .so,${G4BIND_INC}} }
COMMON_LIBS = ${addprefix ${GDMLTOP}/lib,${addsuffix .so, ${COMMON_INC:}} }

release: release-build release-install

release-build:
	cd ${GDMLTOP}/src/CPPGDML ; . CERNConfigure.sh; make; cd ..

release-install: release-install-libs release-install-includes

release-install-libs:
	test -d "${GDMLTOP}/${SCRAM_ARCH}"  || mkdir -p ${GDMLTOP}/${SCRAM_ARCH}
	cd ${GDMLTOP}/${SCRAM_ARCH} ;\
	cp -r ${GDMLTOP}/src/CPPGDML/build/${SCRAM_ARCH}/lib ./  ;\
	cp -r ${GDMLTOP}/src/CPPGDML/build/${SCRAM_ARCH}/bin ./

release-install-includes:
	test -d "${GDMLTOP}/include" || mkdir -p ${GDMLTOP}/include
	cd ${GDMLTOP}/src/CPPGDML ; \
	for pak in $(COMMON_INC); do \
	   cp -f -r Common/$$pak/$$pak ${GDMLTOP}/include ;\
	done
	cd ${GDMLTOP}/src/CPPGDML ; \
	for pak in $(G4BIND_INC);  do \
	  cp -f -r G4Binding/$$pak/$$pak ${GDMLTOP}/include ;\
	done

release-tarballs:
	@if [ ! -e ${GDMLTARDIR}/GDML_${GDML_VERSION}.tar.gz ] ; then \
	  cd ${GDMLTOP}/src ; tar zcf ${GDMLTARDIR}/GDML_${GDML_VERSION}.tar.gz --exclude=CPPGDML/build * ;\
	else \
	  echo "tarball already existing: " ${GDMLTARDIR}/GDML_${GDML_VERSION}.tar.gz ;\
	fi

clean:
	@echo "cleaning up"
	@rm -r CPPGDML/build
	@find . -name \*.o -exec rm {} \;
